name: Mobile Build

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        options:
          - android
          - ios
          - all
  push:
    tags:
      - 'mobile-v*.*.*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all' || startsWith(github.ref, 'refs/tags/mobile-v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install Android targets
      run: |
        rustup target add armv7-linux-androideabi
        rustup target add aarch64-linux-android
        rustup target add i686-linux-android
        rustup target add x86_64-linux-android

    - name: Install cargo-ndk
      run: cargo install cargo-ndk

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        add-to-path: true

    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          core/target
        key: ${{ runner.os }}-cargo-android-${{ hashFiles('**/Cargo.lock') }}

    - name: Build for Android
      run: |
        export ANDROID_NDK_HOME=$ANDROID_NDK_ROOT
        chmod +x scripts/build-android.sh
        ./scripts/build-android.sh

    - name: Upload Android libraries
      uses: actions/upload-artifact@v3
      with:
        name: android-libs
        path: app/android/app/src/main/jniLibs/
        retention-days: 7

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all' || startsWith(github.ref, 'refs/tags/mobile-v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install iOS targets
      run: |
        rustup target add aarch64-apple-ios
        rustup target add x86_64-apple-ios
        rustup target add aarch64-apple-ios-sim

    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          core/target
        key: ${{ runner.os }}-cargo-ios-${{ hashFiles('**/Cargo.lock') }}

    - name: Build for iOS
      run: |
        chmod +x scripts/build-ios.sh
        ./scripts/build-ios.sh

    - name: Upload iOS XCFramework
      uses: actions/upload-artifact@v3
      with:
        name: ios-xcframework
        path: app/ios/Runner/liminal_english_core.xcframework/
        retention-days: 7

  generate-bindings:
    name: Generate Flutter Bindings
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install flutter_rust_bridge_codegen
      run: cargo install flutter_rust_bridge_codegen

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.x'
        channel: 'stable'

    - name: Generate bindings
      run: |
        chmod +x scripts/generate-bindings.sh
        ./scripts/generate-bindings.sh

    - name: Upload bindings
      uses: actions/upload-artifact@v3
      with:
        name: flutter-bindings
        path: app/lib/bridge/generated/
        retention-days: 7
